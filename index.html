<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Rating Task</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css">
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #jspsych-target {
      max-width: 800px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  
  <script>
    /******************************************************
     * Audio Rating Task (slider) + Google Sheets upload
     ******************************************************/

    console.log('Script starting...');

    /* ===== CONFIG ===== */
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwgmPfcREoZ4QHwgk9NQXMYXCXgIuAMX8EuxmkJu0AHAD7YzfVrBo9l2aRqEEjYOKnu/exec';

    /* ===== UI TEXTS ===== */
    const TEXTS = {
      welcomeTitle: 'Audio Rating Task',
      welcomeBody: 'You will hear short sounds and rate them on a scale.',
      startBtn: 'Start',
      prompt: 'How strongly did this sound match the "sarcastic" category?',
      leftLabel: 'Not at all',
      rightLabel: 'Very strongly',
      endTitle: 'Thanks!',
      endBody: 'Your data have been prepared. If upload fails, use the CSV button.',
      finishBtn: 'Finish'
    };

    /* ===== STIMULI ===== */
    const STIMULI = [
      { file: 'preprocess_Yushi_introduce.wav' },
      { file: 'preprocess_Yushi_believe.wav' },
      { file: 'preprocess_Yushi_loveyou.wav' }
    ];

    /* ===== SLIDER SETTINGS ===== */
    const SLIDER = {
      min: 1, max: 7, step: 1, start: 4, require_movement: true,
      labels: ['1','2','3','4','5','6','7']
    };

    /* ===== INIT ===== */
    let jsPsych;
    try {
      jsPsych = initJsPsych({
        display_element: 'jspsych-target',
        on_finish: async () => {
          console.log('Experiment finished');
          const ok = await uploadAllRowsToGoogle();
          if (!ok) {
            const csv = jsPsych.data.get().csv();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = 'data_fallback.csv';
            a.textContent = 'Download CSV (upload failed)';
            a.style.display = 'block';
            a.style.margin = '20px auto';
            a.style.textAlign = 'center';
            document.body.appendChild(a);
          }
        }
      });
      console.log('jsPsych initialized:', jsPsych);
    } catch (error) {
      console.error('Error initializing jsPsych:', error);
      document.body.innerHTML = '<div style="padding: 20px; color: red;">Error initializing jsPsych: ' + error.message + '</div>';
    }

    /* ===== PRELOAD ===== */
    const preload = {
      type: jsPsychPreload,
      audio: STIMULI.map(s => s.file),
      on_error: (file) => {
        console.warn('Failed to load:', file);
      },
      on_success: () => {
        console.log('All files preloaded successfully');
      }
    };

    /* ===== SCREENS ===== */
    const welcome = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>${TEXTS.welcomeTitle}</h2><p>${TEXTS.welcomeBody}</p>`,
      choices: [TEXTS.startBtn]
    };

    const end = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<h2>${TEXTS.endTitle}</h2><p>${TEXTS.endBody}</p>`,
      choices: [TEXTS.finishBtn]
    };

    /* ===== DEMOGRAPHIC SURVEY ===== */
    const demographics = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<h3>참가자 정보</h3><p>아래 정보를 입력해주세요.</p>',
      html: `
        <div style="text-align: left; max-width: 500px; margin: 0 auto;">
          <p><label for="gender"><strong>성별:</strong></label><br>
          <input type="radio" name="gender" value="남" required> 남
          <input type="radio" name="gender" value="여" required> 여</p>
          
          <p><label for="birth_year"><strong>태어난 해:</strong></label><br>
          <input type="text" id="birth_year" name="birth_year" placeholder="YYYY (예: 1995)" pattern="[0-9]{4}" required style="width: 150px;"></p>
          
          <p><label for="birth_month"><strong>태어난 월:</strong></label><br>
          <input type="text" id="birth_month" name="birth_month" placeholder="MM (예: 03)" pattern="[0-9]{2}" required style="width: 80px;"></p>
          
          <p><label for="native_lang"><strong>모국어:</strong></label><br>
          <input type="text" id="native_lang" name="native_lang" placeholder="예: 한국어" required style="width: 200px;"></p>
          
          <p><label for="dialect"><strong>방언:</strong></label><br>
          <input type="text" id="dialect" name="dialect" placeholder="예: 서울, 경상도" style="width: 200px;"></p>
          
          <p><label for="foreign_lang"><strong>외국어:</strong></label><br>
          <input type="text" id="foreign_lang" name="foreign_lang" placeholder="예: 영어, 일본어" style="width: 300px;"></p>
        </div>
      `,
      button_label: '제출',
      data: { task: 'demographics' },
      on_finish: (data) => {
        data.user_agent = navigator.userAgent;
        data.timestamp = new Date().toISOString();
        console.log('Demographics:', data.response);
      }
    };

    /* ===== RATING TRIAL ===== */
    let currentTrialStartTime = null;

    const rating_trial = {
      type: jsPsychAudioSliderResponse,
      stimulus: jsPsych.timelineVariable('file'),
      prompt: `<p>${TEXTS.prompt}</p>
               <div style="display:flex;justify-content:space-between;font-size:0.9rem;margin-top:4px;">
                <span>${TEXTS.leftLabel}</span><span>${TEXTS.rightLabel}</span>
               </div>`,
      min: SLIDER.min,
      max: SLIDER.max,
      slider_start: SLIDER.start,
      step: SLIDER.step,
      labels: SLIDER.labels,
      require_movement: SLIDER.require_movement,
      response_allowed_while_playing: false,
      trial_ends_after_audio: false,
      data: { 
        task: 'rating', 
        stimulus_file: jsPsych.timelineVariable('file')
      },
      on_load: function() {
        // 트라이얼 시작 시점 기록
        currentTrialStartTime = new Date().toISOString();
        console.log('Trial loaded, start time:', currentTrialStartTime);
      },
      on_finish: (data) => {
        data.rating = data.response;
        data.stimulus = data.stimulus_file || data.stimulus;
        data.trial_start_time = currentTrialStartTime;
        data.response_time = new Date().toISOString(); // 응답한 시점
        data.user_agent = navigator.userAgent;
        
        console.log('Trial finished:', {
          stimulus: data.stimulus,
          rating: data.rating,
          trial_start: data.trial_start_time,
          response: data.response_time
        });
      }
    };

    /* ===== RANDOM ORDER BLOCK ===== */
    const rating_block = {
      timeline: [rating_trial],
      timeline_variables: STIMULI,
      randomize_order: true
    };

    /* ===== RUN ===== */
    if (jsPsych) {
      console.log('Starting experiment...');
      jsPsych.run([preload, welcome, rating_block, demographics, end]);
    } else {
      console.error('jsPsych not initialized');
    }

    /* ===== GOOGLE UPLOAD ===== */
    async function uploadAllRowsToGoogle() {
      if (!GAS_ENDPOINT || GAS_ENDPOINT.startsWith('PASTE_')) {
        console.warn('No GAS endpoint configured.');
        return false;
      }
      try {
        const allData = jsPsych.data.get().values();
        
        const demoData = allData.find(d => d.task === 'demographics');
        const demographics = demoData?.response || {};
        
        const rows = allData
          .filter(d => d.task === 'rating')
          .map(d => {
            // rt 필드를 명시적으로 제외
            const { rt, rt_original, rt_after_audio, ...cleanData } = d;
            return {
              trial_index:      cleanData.trial_index,
              task:             cleanData.task,
              stimulus:         cleanData.stimulus || cleanData.stimulus_file || '',
              rating:           cleanData.rating ?? cleanData.response,
              time_elapsed:     cleanData.time_elapsed,
              trial_start_time: cleanData.trial_start_time || '',
              response_time:    cleanData.response_time || '',
              user_agent:       cleanData.user_agent || navigator.userAgent,
              gender:           demographics.gender || '',
              birth_year:       demographics.birth_year || '',
              birth_month:      demographics.birth_month || '',
              native_lang:      demographics.native_lang || '',
              dialect:          demographics.dialect || '',
              foreign_lang:     demographics.foreign_lang || ''
            };
          });

        await fetch(GAS_ENDPOINT, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rows)
        });
        console.log('Upload attempted. Check your Google Sheet.');
        return true;
      } catch (e) {
        console.warn('Upload error:', e);
        return false;
      }
    }
  </script>
</body>
</html>

